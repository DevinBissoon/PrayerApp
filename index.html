<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Bible Helper</title>
    <!-- Use Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Optional: Use a specific font for better aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-serif {
            font-family: 'Playfair Display', serif;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6d28d9;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Main container for the application UI -->
    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">
        <!-- The content will be rendered here by JavaScript -->
    </div>

    <script>
        // Get the main container element
        const appContainer = document.getElementById('app-container');

        // State variables to manage the app's current status
        let stage = 'start';
        let userFeeling = '';
        let selectedVerse = null; // Single verse object
        let isLoading = false;
        let audio = null;

        // Function to handle the form submission in the 'ask' stage. yes
        const handleSubmit = async (e) => {
            e.preventDefault();
            if (isLoading) return;

            const inputElement = document.getElementById('feeling-input');
            userFeeling = inputElement.value;
            if (userFeeling.trim() === '') return;

            isLoading = true;
            renderContent();

            try {
                // Add a unique timestamp and an explicit instruction to find a different verse.
                const uniqueId = new Date().getTime();
                const prompt = `Based on the following feeling: "${userFeeling}", provide a single, uplifting and relevant Bible verse. The goal is to provide a different verse each time the user asks. Avoid giving the most common or well-known verse for this topic. Unique request ID: ${uniqueId}. Format your response as a JSON object with two fields: "text" and "reference". For example: {"text": "For I know the plans I have for you,” declares the Lord, “plans to prosper you and not to harm you, plans to give you hope and a future.", "reference": "Jeremiah 29:11"}. Be sure to provide the full text of the verse.`;
                
                // Define the payload for the API call.
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "text": { "type": "STRING" },
                                "reference": { "type": "STRING" }
                            },
                            "propertyOrdering": ["text", "reference"]
                        }
                    }
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    selectedVerse = JSON.parse(jsonString);
                } else {
                    selectedVerse = {
                        text: "An error occurred while fetching the verse. Please try again.",
                        reference: "Unknown"
                    };
                }

            } catch (error) {
                console.error("API call failed:", error);
                selectedVerse = {
                    text: "I'm sorry, an error occurred. Please try again.",
                    reference: "Unknown"
                };
            } finally {
                isLoading = false;
                stage = 'result';
                renderContent();
            }
        };

        // Function to get and play the audio for the verse.
        const handleReadAloud = async () => {
            if (!selectedVerse || isLoading) return;

            // Stop any currently playing audio
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }

            isLoading = true;
            renderContent();

            try {
                const textToSpeak = `${selectedVerse.text}. From the book of ${selectedVerse.reference}.`;
                const payload = {
                    contents: [{ parts: [{ text: textToSpeak }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Zephyr" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const audioPart = result?.candidates?.[0]?.content?.parts?.[0];

                if (audioPart && audioPart.inlineData && audioPart.inlineData.data) {
                    const base64Data = audioPart.inlineData.data;
                    const mimeType = audioPart.inlineData.mimeType;

                    // Function to convert Base64 to ArrayBuffer
                    const base64ToArrayBuffer = (base64) => {
                        const binaryString = atob(base64);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        return bytes.buffer;
                    };

                    // Function to convert PCM to WAV format
                    const pcmToWav = (pcmData, sampleRate) => {
                        const pcm16 = new Int16Array(pcmData);
                        const buffer = new ArrayBuffer(44 + pcm16.length * 2);
                        const view = new DataView(buffer);

                        // RIFF identifier 'RIFF'
                        writeString(view, 0, 'RIFF');
                        // file length
                        view.setUint32(4, 36 + pcm16.length * 2, true);
                        // RIFF type 'WAVE'
                        writeString(view, 8, 'WAVE');
                        // format chunk identifier 'fmt '
                        writeString(view, 12, 'fmt ');
                        // format chunk length
                        view.setUint32(16, 16, true);
                        // sample format (raw)
                        view.setUint16(20, 1, true);
                        // channel count
                        view.setUint16(22, 1, true);
                        // sample rate
                        view.setUint32(24, sampleRate, true);
                        // byte rate (sample rate * block align)
                        view.setUint32(28, sampleRate * 2, true);
                        // block align (channel count * bytes per sample)
                        view.setUint16(32, 2, true);
                        // bits per sample
                        view.setUint16(34, 16, true);
                        // data chunk identifier 'data'
                        writeString(view, 36, 'data');
                        // data chunk length
                        view.setUint32(40, pcm16.length * 2, true);

                        // Write the PCM data
                        let offset = 44;
                        for (let i = 0; i < pcm16.length; i++, offset += 2) {
                            view.setInt16(offset, pcm16[i], true);
                        }

                        return new Blob([view], { type: 'audio/wav' });
                    };

                    // Helper function for PCM to WAV conversion
                    const writeString = (view, offset, string) => {
                        for (let i = 0; i < string.length; i++) {
                            view.setUint8(offset + i, string.charCodeAt(i));
                        }
                    };
                    
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(base64Data);
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audio = new Audio(audioUrl);
                    audio.play().catch(e => console.error("Audio playback failed:", e));

                } else {
                    console.error("Audio data not found in response.");
                }

            } catch (error) {
                console.error("Audio API call failed:", error);
            } finally {
                isLoading = false;
                renderContent();
            }
        };

        // Function to reset the app to the initial 'start' stage.
        const handleStartOver = () => {
            stage = 'start';
            userFeeling = '';
            selectedVerse = null;
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            renderContent();
        };

        // Renders the main UI based on the current 'stage'
        const renderContent = () => {
            let htmlContent = '';
            switch (stage) {
                case 'start':
                    htmlContent = `
                        <div class="bg-white rounded-3xl shadow-2xl p-8 sm:p-12 max-w-2xl w-full">
                            <div class="flex flex-col items-center space-y-4 text-center">
                                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Your Bible Helper</h1>
                                <p class="text-lg sm:text-xl text-gray-600 max-w-md">
                                    A simple, private space to find a Bible verse that resonates with your heart today.
                                </p>
                                <button id="start-button"
                                    class="mt-6 px-8 py-4 bg-purple-600 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105">
                                    Find Your Verse
                                </button>
                            </div>
                        </div>
                    `;
                    appContainer.innerHTML = htmlContent;
                    document.getElementById('start-button').addEventListener('click', () => {
                        stage = 'ask';
                        renderContent();
                    });
                    break;

                case 'ask':
                    htmlContent = `
                        <div class="bg-white rounded-3xl shadow-2xl p-8 sm:p-12 max-w-2xl w-full">
                            <div class="flex flex-col items-center space-y-6 w-full max-w-xl text-center">
                                <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">How are you feeling today?</h2>
                                <p class="text-md sm:text-lg text-gray-600">
                                    In a few words, describe what's on your heart
                                </p>
                                <form id="verse-form" class="w-full">
                                    <input
                                        type="text"
                                        id="feeling-input"
                                        value="${userFeeling}"
                                        placeholder="e.g., Anxious, grateful, in need of guidance..."
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200"
                                    />
                                    <button
                                        type="submit"
                                        class="mt-6 w-full px-8 py-4 bg-purple-600 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105">
                                        Find a Verse
                                    </button>
                                </form>
                            </div>
                        </div>
                    `;
                    appContainer.innerHTML = htmlContent;
                    document.getElementById('verse-form').addEventListener('submit', handleSubmit);
                    break;

                case 'result':
                    if (isLoading) {
                        // Updated loading state HTML
                        htmlContent = `
                            <div class="bg-white rounded-3xl shadow-2xl p-8 sm:p-12 max-w-2xl w-full flex flex-col items-center justify-center">
                                <div class="spinner"></div>
                                <p class="mt-6 text-xl text-gray-600 font-semibold text-center">
                                    Finding a verse just for you...
                                </p>
                            </div>
                        `;
                    } else {
                        const verseHtml = selectedVerse ? `
                            <p class="text-2xl sm:text-3xl italic text-gray-700 font-serif leading-relaxed mb-4">
                                “${selectedVerse.text}”
                            </p>
                            <p class="text-lg font-semibold text-purple-600 border-t border-gray-200 pt-4">
                                ${selectedVerse.reference}
                            </p>
                        ` : '';
                        htmlContent = `
                            <div class="bg-white rounded-3xl shadow-2xl p-8 sm:p-12 max-w-2xl w-full">
                                <div class="flex flex-col items-center space-y-6 text-center w-full max-w-xl">
                                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">A verse for your heart:</h2>
                                    <div class="bg-gray-50 p-6 rounded-2xl shadow-xl w-full">
                                        ${verseHtml}
                                    </div>
                                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-6 w-full">
                                        <button id="read-aloud-button"
                                            class="w-full sm:w-1/2 px-8 py-4 bg-purple-600 text-white text-lg font-semibold rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105">
                                            Read Aloud
                                        </button>
                                        <button id="start-over-button"
                                            class="w-full sm:w-1/2 px-8 py-4 bg-gray-200 text-gray-800 text-lg font-semibold rounded-full shadow-lg hover:bg-gray-300 transition duration-300 transform hover:scale-105">
                                            Start Over
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    appContainer.innerHTML = htmlContent;
                    if (!isLoading) {
                        document.getElementById('start-over-button').addEventListener('click', handleStartOver);
                        document.getElementById('read-aloud-button').addEventListener('click', handleReadAloud);
                    }
                    break;

                default:
                    // Fallback to the start screen
                    stage = 'start';
                    renderContent();
            }
        };

        // Initial call to render the app on page load
        document.addEventListener('DOMContentLoaded', renderContent);
    </script>
</body>
</html>
